<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <title>Customer Portal Single Sign-in Token</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.4/css/bootstrap.css">
    <style>body { padding-top: 60px; }</style>
  </head>
  <body>
    <div class="container">
      <div class="row">
        <div class="col-sm-6 col-sm-offset-3">
          <form class="jumbotron">
            <h3>Customer Portal Single Sign-in Token</h3>

            <small>
              A simple JavaScript client, which is creating Customer Person session in Customer Portal.<br>
              In order to authenticate into Customer API it uses an Single Sign-in Token generated by Home API.
            </small>

            <p></p>

            <div
              class="alert alert-danger js-error-handler"
              role="alert"
              style="display: none;"></div>

            <div class="form-group">
              <label
                for="xtrfUrl">
                XTRF Url</label>

              <input
                name="xtrfUrl"
                type="text"
                class="form-control"
                placeholder="https://localhost:8443">
            </div>

            <div class="form-group">
              <label
                for="accessToken">
                Access Token</label>

              <input
                name="accessToken"
                type="text"
                class="form-control"
                placeholder="cywxenEfjtdG8WBz4mHnmcpi9y">

              <span
                class="help-block">
                To generate one go to <em>My Account</em> then <em>Access Tokens</em> tab and click <em>Edit</em> button.</span>
            </div>

            <div class="form-group">
              <label
                for="loginOrEmail">
                Email or login</label>

              <input
                name="loginOrEmail"
                type="text"
                class="form-control"
                placeholder="Becky Wilson">
            </div>

            <button class="btn btn-primary js-check-session">Check session</button>
          </form>
        </div>
      </div>

      <div class="row">
        <div class="col-sm-6 col-sm-offset-3">
          <pre class="js-dump-data" style="display: none;"></pre>
        </div>
      </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <script type="text/javascript">
    (function() {
      'use strict';

      var XTRF_URL;

      var dumpData = function(data) {
        $('.js-dump-data')
          .text(function() {
            return JSON.stringify(data, null, 4);
          })
          .show();
      };

      var errorHandler = function(jqXHR) {
        $('.js-error-handler')
          .html(function() {
            return [
              '<strong>', jqXHR.status, '</strong> ',
              jqXHR.statusText
            ].join('');
          })
          .show();
      };

      var api = {
        home: {
          customersPersonsAccessToken: function(data) {
            return $.ajax({
              url: XTRF_URL + '/home-api/customers/persons/accessToken',
              type: 'POST',

              headers: {
                // Header to specify API version
                'Accept': 'application/vnd.xtrf-v1+json',
                // Header to provide the access token
                'X-AUTH-ACCESS-TOKEN': data.accessToken
              },

              // Response is expected to be json
              dataType: 'json',

              // Request data is needed to be in body
              // as json not encoded form
              contentType: 'application/json',

              // Due to requirement to content type be json
              // convert JavaScript Plain Object to string
              data: JSON.stringify({
                loginOrEmail: data.loginOrEmail
              })
            })
            .error(errorHandler);
          }
        },

        customer: {
          systemSession: function(data) {
            return $.ajax({
              url: XTRF_URL + '/customer-api/system/session',
              type: 'GET',

              // Response is expected to be json
              dataType: 'json',

              // Enable cross-domain requests
              xhrFields: {
                withCredentials: true
              },
            })
            .error(errorHandler);
          },

          systemLoginWithToken: function(data) {
            return $.ajax({
              url: XTRF_URL + '/customer-api/system/loginWithToken',
              type: 'POST',

              // Response is expected to be json
              dataType: 'json',

              data: {
                accessToken: data.token
              },

              // Enable cross-domain requests
              xhrFields: {
                withCredentials: true
              },
            })
            .error(errorHandler);
          }
        }
      };


      $('.js-check-session').on('click', function(event) {
        event.preventDefault();

        var parser = document.createElement('a');

        var data = {
          accessToken: $('[name="accessToken"]').val(),
          loginOrEmail: $('[name="loginOrEmail"]').val()
        };

        parser.href = $('[name="xtrfUrl"]').val();
        XTRF_URL = parser.protocol + '//' + parser.host;

        $('.js-error-handler').hide();
        $('.js-dump-data').hide();

        api.home.customersPersonsAccessToken(data)
          .success(function(data) {
            api.customer.systemLoginWithToken(data)
              .success(function(data) {
                api.customer.systemSession(data)
                  .success(dumpData);
              });
          });
      });
    }());
    </script>
  </body>
</html>
